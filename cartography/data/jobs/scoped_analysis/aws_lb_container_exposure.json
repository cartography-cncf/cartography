{
  "name": "AWS LoadBalancer to ECS Container direct relationship",
  "statements": [
    {
      "__comment": "Cleanup: Remove stale EXPOSE relationships between LBs and containers for this account",
      "query": "MATCH (aa:AWSAccount{id: $AWS_ID})-[:RESOURCE]->(lb:AWSLoadBalancerV2)-[r:EXPOSE]->(:ECSContainer) WHERE r.lastupdated <> $UPDATE_TAG DELETE r",
      "iterative": true
    },
    {
      "__comment": "Create: EXPOSE relationships for containers behind internet-facing load balancers, joined via target group ARN on both the LB's EXPOSE rel and the ECS service",
      "query": "MATCH (aa:AWSAccount{id: $AWS_ID})-[:RESOURCE]->(lb:AWSLoadBalancerV2 {scheme: 'internet-facing'})-[e:EXPOSE]->() WHERE e.target_group_arn IS NOT NULL WITH aa, lb, e MATCH (aa)-[:RESOURCE]->(svc:ECSService) WHERE e.target_group_arn IN svc.target_group_arns MATCH (svc)-[:HAS_TASK]->(task:ECSTask)-[:HAS_CONTAINER]->(c:ECSContainer) MERGE (lb)-[r:EXPOSE]->(c) SET r.lastupdated = $UPDATE_TAG, r.exposure_type = 'via_lb_only'",
      "iterative": false
    }
  ]
}
