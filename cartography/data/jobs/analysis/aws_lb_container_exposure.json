{
  "name": "AWS LoadBalancer to ECS Container direct relationship",
  "statements": [
    {
      "__comment": "Cleanup: Remove all previous EXPOSE relationships between LBs and containers",
      "query": "MATCH (:AWSLoadBalancerV2)-[r:EXPOSE]->(:ECSContainer) DELETE r",
      "iterative": false
    },
    {
      "__comment": "Create: EXPOSE relationships for private containers behind internet-facing load balancers",
      "query": "MATCH (lb:AWSLoadBalancerV2 {scheme: 'internet-facing'})-[:EXPOSE]->(ip:EC2PrivateIp)<-[:PRIVATE_IP_ADDRESS]-(ni:NetworkInterface)<-[:NETWORK_INTERFACE]-(task:ECSTask)-[:HAS_CONTAINER]->(c:ECSContainer) WHERE ni.public_ip IS NULL MERGE (lb)-[r:EXPOSE]->(c) SET r.lastupdated = $UPDATE_TAG, r.exposure_type = 'via_lb_only'",
      "iterative": false
    }
  ]
}
