from cartography.rules.spec.model import Fact
from cartography.rules.spec.model import Finding
from cartography.rules.spec.model import Maturity
from cartography.rules.spec.model import Module
from cartography.rules.spec.model import Rule
from cartography.rules.spec.model import RuleReference

# Facts
_malicious_npm_dependencies_shai_hulud_sept_2025_github = Fact(
    id="malicious-npm-dependencies-shai-hulud-sept-2025-github",
    name="GitHub repositories with Shai-Hulud malicious npm dependencies (September 2025 wave)",
    description="Finds GitHub repositories that depend on npm packages compromised during the September 2025 wave of the Shai-Hulud attack campaign.",
    cypher_query="""
    WITH [
      { name: 'ansi-regex', version: '6.2.1' },
      { name: 'ansi-styles', version: '6.2.2' },
      { name: 'backslash', version: '0.2.1' },
      { name: 'chalk', version: '5.6.1' },
      { name: 'chalk-template', version: '1.1.1' },
      { name: 'color-convert', version: '3.1.1' },
      { name: 'color-name', version: '2.0.1' },
      { name: 'color-string', version: '2.1.1' },
      { name: 'debug', version: '4.4.2' },
      { name: 'error-ex', version: '1.3.3' },
      { name: 'has-ansi', version: '6.0.1' },
      { name: 'is-arrayish', version: '0.3.3' },
      { name: 'simple-swizzle', version: '0.2.3' },
      { name: 'slice-ansi', version: '7.1.1' },
      { name: 'strip-ansi', version: '7.1.1' },
      { name: 'supports-color', version: '10.2.1' },
      { name: 'supports-hyperlinks', version: '4.1.1' },
      { name: 'wrap-ansi', version: '9.0.1' },
      { name: '@coveops/abi', version: '2.0.1' },
      { name: 'duckdb', version: '1.3.3' },
      { name: '@duckdb/node-bindings', version: '1.3.3' },
      { name: '@duckdb/duckdb-wasm', version: '1.29.2' },
      { name: '@duckdb/node-api', version: '1.3.3' },
      { name: '@ctrl/tinycolor', version: '4.1.1' },
      { name: '@ctrl/tinycolor', version: '4.1.2' },
      { name: '@ctrl/deluge', version: '1.2.0' },
      { name: '@ctrl/deluge', version: '7.2.1' },
      { name: '@ctrl/deluge', version: '7.2.2' },
      { name: '@ctrl/golang-template', version: '1.4.2' },
      { name: '@ctrl/golang-template', version: '1.4.3' },
      { name: '@ctrl/magnet-link', version: '4.0.3' },
      { name: '@ctrl/magnet-link', version: '4.0.4' },
      { name: '@ahmedhfarag/ngx-perfect-scrollbar', version: '20.0.20' },
      { name: '@ahmedhfarag/ngx-virtual-scroller', version: '4.0.4' },
      { name: '@art-ws/common', version: '2.0.22' },
      { name: '@art-ws/common', version: '2.0.28' },
      { name: 'rxnt-authentication', version: '0.0.3' },
      { name: 'rxnt-authentication', version: '0.0.4' }
    ] AS vulnerable
    UNWIND vulnerable AS v
    MATCH (d:Dependency {ecosystem: 'npm', name: v.name})--(manifest:DependencyGraphManifest)--(r:GitHubRepository)
    RETURN r.fullname as repo, d.name as name, d.requirements as current_version, v.version AS vulnerable_version,
    (REPLACE(d.requirements, "= ", "") = v.version) AS is_vulnerable
    """,
    cypher_visual_query="""
    WITH [
      { name: 'ansi-regex', version: '6.2.1' },
      { name: 'ansi-styles', version: '6.2.2' },
      { name: 'backslash', version: '0.2.1' },
      { name: 'chalk', version: '5.6.1' },
      { name: 'chalk-template', version: '1.1.1' },
      { name: 'color-convert', version: '3.1.1' },
      { name: 'color-name', version: '2.0.1' },
      { name: 'color-string', version: '2.1.1' },
      { name: 'debug', version: '4.4.2' },
      { name: 'error-ex', version: '1.3.3' },
      { name: 'has-ansi', version: '6.0.1' },
      { name: 'is-arrayish', version: '0.3.3' },
      { name: 'simple-swizzle', version: '0.2.3' },
      { name: 'slice-ansi', version: '7.1.1' },
      { name: 'strip-ansi', version: '7.1.1' },
      { name: 'supports-color', version: '10.2.1' },
      { name: 'supports-hyperlinks', version: '4.1.1' },
      { name: 'wrap-ansi', version: '9.0.1' },
      { name: '@coveops/abi', version: '2.0.1' },
      { name: 'duckdb', version: '1.3.3' },
      { name: '@duckdb/node-bindings', version: '1.3.3' },
      { name: '@duckdb/duckdb-wasm', version: '1.29.2' },
      { name: '@duckdb/node-api', version: '1.3.3' },
      { name: '@ctrl/tinycolor', version: '4.1.1' },
      { name: '@ctrl/tinycolor', version: '4.1.2' },
      { name: '@ctrl/deluge', version: '1.2.0' },
      { name: '@ctrl/deluge', version: '7.2.1' },
      { name: '@ctrl/deluge', version: '7.2.2' },
      { name: '@ctrl/golang-template', version: '1.4.2' },
      { name: '@ctrl/golang-template', version: '1.4.3' },
      { name: '@ctrl/magnet-link', version: '4.0.3' },
      { name: '@ctrl/magnet-link', version: '4.0.4' },
      { name: '@ahmedhfarag/ngx-perfect-scrollbar', version: '20.0.20' },
      { name: '@ahmedhfarag/ngx-virtual-scroller', version: '4.0.4' },
      { name: '@art-ws/common', version: '2.0.22' },
      { name: '@art-ws/common', version: '2.0.28' },
      { name: 'rxnt-authentication', version: '0.0.3' },
      { name: 'rxnt-authentication', version: '0.0.4' }
    ] AS vulnerable
    UNWIND vulnerable AS v
    MATCH (d:Dependency {ecosystem: 'npm', name: v.name})--(manifest:DependencyGraphManifest)--(r:GitHubRepository)
    RETURN r, d
    """,
    module=Module.GITHUB,
    maturity=Maturity.EXPERIMENTAL,
)


_malicious_npm_dependencies_shai_hulud_nov_2025_github = Fact(
    id="malicious-npm-dependencies-shai-hulud-nov-2025-github",
    name="GitHub repositories with Shai-Hulud malicious npm dependencies (November 2025 wave)",
    description="Finds GitHub repositories that depend on npm packages compromised during the November 2025 wave of the Shai-Hulud attack campaign.",
    cypher_query="""
    WITH [
      { name: '@zapier/zapier-sdk', version: '0.15.5' },
      { name: '@zapier/zapier-sdk', version: '0.15.7' },
      { name: '@posthog/core', version: '1.5.6' },
      { name: 'posthog-node', version: '5.11.3' },
      { name: 'posthog-node', version: '5.13.3' },
      { name: 'posthog-node', version: '4.18.1' },
      { name: '@asyncapi/specs', version: '6.10.1' },
      { name: '@asyncapi/specs', version: '6.8.2' },
      { name: '@asyncapi/specs', version: '6.9.1' },
      { name: '@asyncapi/specs', version: '6.8.3' },
      { name: '@postman/tunnel-agent', version: '0.6.6' },
      { name: '@postman/tunnel-agent', version: '0.6.5' },
      { name: 'posthog-react-native', version: '4.12.5' },
      { name: 'posthog-react-native', version: '4.11.1' },
      { name: '@asyncapi/parser', version: '3.4.1' },
      { name: '@asyncapi/parser', version: '3.4.2' },
      { name: '@asyncapi/openapi-schema-parser', version: '3.0.25' },
      { name: '@asyncapi/avro-schema-parser', version: '3.0.25' },
      { name: '@asyncapi/avro-schema-parser', version: '3.0.26' },
      { name: '@asyncapi/protobuf-schema-parser', version: '3.6.1' },
      { name: '@asyncapi/protobuf-schema-parser', version: '3.5.3' },
      { name: '@asyncapi/react-component', version: '2.6.6' },
      { name: '@asyncapi/generator', version: '2.8.5' },
      { name: '@posthog/ai', version: '7.1.2' },
      { name: '@asyncapi/modelina', version: '5.10.2' },
      { name: '@asyncapi/modelina', version: '5.10.3' },
      { name: '@asyncapi/generator-react-sdk', version: '1.1.4' },
      { name: '@asyncapi/generator-react-sdk', version: '1.1.5' },
      { name: '@postman/csv-parse', version: '4.0.3' },
      { name: '@postman/csv-parse', version: '4.0.4' },
      { name: '@postman/csv-parse', version: '4.0.5' },
      { name: 'posthog-react-native-session-replay', version: '1.2.2' },
      { name: '@asyncapi/converter', version: '1.6.3' },
      { name: '@asyncapi/multi-parser', version: '2.2.1' },
      { name: '@asyncapi/multi-parser', version: '2.2.2' },
      { name: '@posthog/cli', version: '0.5.15' },
      { name: '@zapier/secret-scrubber', version: '1.1.3' },
      { name: '@zapier/secret-scrubber', version: '1.1.4' },
      { name: '@zapier/secret-scrubber', version: '1.1.5' },
      { name: 'zapier-platform-schema', version: '18.0.2' },
      { name: 'zapier-platform-core', version: '18.0.2' },
      { name: 'zapier-platform-core', version: '18.0.3' },
      { name: '@ensdomains/address-encoder', version: '1.1.5' },
      { name: '@ensdomains/content-hash', version: '3.0.1' },
      { name: 'crypto-addr-codec', version: '0.1.9' },
      { name: '@asyncapi/nunjucks-filters', version: '2.1.1' },
      { name: '@asyncapi/nunjucks-filters', version: '2.1.2' },
      { name: '@asyncapi/bundler', version: '0.6.5' },
      { name: '@asyncapi/bundler', version: '0.6.6' },
      { name: '@posthog/nextjs-config', version: '1.5.1' },
      { name: '@asyncapi/html-template', version: '3.3.2' },
      { name: '@asyncapi/html-template', version: '3.3.3' },
      { name: '@asyncapi/diff', version: '0.5.1' },
      { name: '@asyncapi/diff', version: '0.5.2' },
      { name: '@asyncapi/cli', version: '4.1.2' },
      { name: '@asyncapi/optimizer', version: '1.0.5' },
      { name: '@asyncapi/optimizer', version: '1.0.6' },
      { name: '@asyncapi/modelina-cli', version: '5.10.2' },
      { name: '@asyncapi/modelina-cli', version: '5.10.3' },
      { name: '@postman/aether-icons', version: '2.23.2' },
      { name: '@postman/aether-icons', version: '2.23.4' },
      { name: '@asyncapi/generator-components', version: '0.3.2' },
      { name: '@asyncapi/generator-helpers', version: '0.2.1' },
      { name: '@asyncapi/generator-helpers', version: '0.2.2' },
      { name: 'zapier-platform-cli', version: '18.0.3' },
      { name: '@posthog/rrweb', version: '0.0.31' },
      { name: 'ethereum-ens', version: '0.8.1' },
      { name: '@posthog/rrweb-utils', version: '0.0.31' },
      { name: '@posthog/rrweb-snapshot', version: '0.0.31' },
      { name: '@posthog/rrdom', version: '0.0.31' },
      { name: '@asyncapi/problem', version: '1.0.1' },
      { name: '@asyncapi/problem', version: '1.0.2' },
      { name: '@postman/secret-scanner-wasm', version: '2.1.3' },
      { name: '@postman/secret-scanner-wasm', version: '2.1.2' },
      { name: '@postman/secret-scanner-wasm', version: '2.1.4' },
      { name: '@ensdomains/eth-ens-namehash', version: '2.0.16' },
      { name: 'posthog-docusaurus', version: '2.0.6' },
      { name: '@postman/pretty-ms', version: '6.1.1' },
      { name: '@postman/pretty-ms', version: '6.1.3' },
      { name: '@postman/pretty-ms', version: '6.1.2' },
      { name: 'web-types-lit', version: '0.1.1' },
      { name: 'mcp-use', version: '1.4.2' },
      { name: 'mcp-use', version: '1.4.3' },
      { name: '@posthog/react-rrweb-player', version: '1.1.4' },
      { name: '@asyncapi/markdown-template', version: '1.6.8' },
      { name: '@asyncapi/markdown-template', version: '1.6.9' },
      { name: '@ensdomains/buffer', version: '0.1.2' },
      { name: '@postman/node-keytar', version: '7.9.4' },
      { name: '@postman/node-keytar', version: '7.9.5' },
      { name: '@postman/node-keytar', version: '7.9.6' },
      { name: '@mcp-use/inspector', version: '0.6.2' },
      { name: '@mcp-use/inspector', version: '0.6.3' },
      { name: '@mcp-use/cli', version: '2.2.6' },
      { name: '@zapier/spectral-api-ruleset', version: '1.9.1' },
      { name: '@zapier/spectral-api-ruleset', version: '1.9.2' },
      { name: '@zapier/spectral-api-ruleset', version: '1.9.3' },
      { name: '@posthog/geoip-plugin', version: '0.0.8' },
      { name: '@ensdomains/dnsprovejs', version: '0.5.3' },
      { name: '@ensdomains/solsha1', version: '0.0.4' },
      { name: '@asyncapi/web-component', version: '2.6.6' },
      { name: '@asyncapi/web-component', version: '2.6.7' },
      { name: '@posthog/nuxt', version: '1.2.9' },
      { name: '@zapier/browserslist-config-zapier', version: '1.0.3' },
      { name: '@zapier/browserslist-config-zapier', version: '1.0.5' },
      { name: '@posthog/wizard', version: '1.18.1' },
      { name: 'react-native-use-modal', version: '1.0.3' },
      { name: '@asyncapi/java-spring-template', version: '1.6.1' },
      { name: '@asyncapi/java-spring-template', version: '1.6.2' },
      { name: '@posthog/rrweb-record', version: '0.0.31' },
      { name: '@posthog/siphash', version: '1.1.2' },
      { name: '@posthog/piscina', version: '3.2.1' },
      { name: '@ensdomains/ens-validation', version: '0.1.1' },
      { name: '@posthog/plugin-contrib', version: '0.0.6' },
      { name: '@posthog/agent', version: '1.24.1' },
      { name: '@postman/postman-mcp-server', version: '2.4.11' },
      { name: '@postman/postman-mcp-server', version: '2.4.10' },
      { name: '@asyncapi/nodejs-ws-template', version: '0.10.1' },
      { name: '@asyncapi/nodejs-ws-template', version: '0.10.2' },
      { name: '@actbase/react-daum-postcode', version: '1.0.5' },
      { name: 'token.js-fork', version: '0.7.32' },
      { name: '@postman/pm-bin-windows-x64', version: '1.24.5' },
      { name: '@postman/pm-bin-windows-x64', version: '1.24.4' },
      { name: '@ensdomains/ens-avatar', version: '1.0.4' },
      { name: '@postman/pm-bin-linux-x64', version: '1.24.3' },
      { name: '@postman/pm-bin-linux-x64', version: '1.24.4' },
      { name: '@postman/pm-bin-linux-x64', version: '1.24.5' },
      { name: '@posthog/hedgehog-mode', version: '0.0.42' },
      { name: 'create-mcp-use-app', version: '0.5.3' },
      { name: 'create-mcp-use-app', version: '0.5.4' },
      { name: '@postman/pm-bin-macos-arm64', version: '1.24.5' },
      { name: '@postman/pm-bin-macos-arm64', version: '1.24.3' },
      { name: '@postman/pm-bin-macos-arm64', version: '1.24.4' },
      { name: '@posthog/nextjs', version: '0.0.3' },
      { name: '@postman/pm-bin-macos-x64', version: '1.24.3' },
      { name: '@postman/pm-bin-macos-x64', version: '1.24.5' },
      { name: 'redux-router-kit', version: '1.2.2' },
      { name: 'redux-router-kit', version: '1.2.3' },
      { name: 'redux-router-kit', version: '1.2.4' },
      { name: '@ensdomains/dnssecoraclejs', version: '0.2.9' },
      { name: '@postman/mcp-ui-client', version: '5.5.1' },
      { name: '@postman/mcp-ui-client', version: '5.5.2' },
      { name: '@postman/postman-mcp-cli', version: '1.0.5' },
      { name: '@postman/postman-mcp-cli', version: '1.0.4' },
      { name: '@zapier/babel-preset-zapier', version: '6.4.1' },
      { name: '@zapier/babel-preset-zapier', version: '6.4.3' },
      { name: '@ensdomains/thorin', version: '0.6.51' },
      { name: '@postman/postman-collection-fork', version: '4.3.3' },
      { name: '@postman/postman-collection-fork', version: '4.3.4' },
      { name: '@postman/postman-collection-fork', version: '4.3.5' },
      { name: '@asyncapi/nodejs-template', version: '3.0.5' },
      { name: '@postman/wdio-allure-reporter', version: '0.0.9' },
      { name: '@postman/wdio-junit-reporter', version: '0.0.4' },
      { name: '@postman/wdio-junit-reporter', version: '0.0.6' },
      { name: '@postman/final-node-keytar', version: '7.9.1' },
      { name: '@postman/final-node-keytar', version: '7.9.2' },
      { name: 'zapier-async-storage', version: '1.0.1' },
      { name: 'zapier-async-storage', version: '1.0.2' },
      { name: 'zapier-async-storage', version: '1.0.3' },
      { name: '@ensdomains/test-utils', version: '1.3.1' },
      { name: '@ensdomains/hardhat-chai-matchers-viem', version: '0.1.15' },
      { name: '@asyncapi/java-spring-cloud-stream-template', version: '0.13.5' },
      { name: '@asyncapi/java-spring-cloud-stream-template', version: '0.13.6' },
      { name: '@zapier/eslint-plugin-zapier', version: '11.0.3' },
      { name: '@zapier/eslint-plugin-zapier', version: '11.0.4' },
      { name: '@zapier/eslint-plugin-zapier', version: '11.0.5' },
      { name: 'devstart-cli', version: '1.0.6' },
      { name: '@asyncapi/java-template', version: '0.3.5' },
      { name: '@asyncapi/java-template', version: '0.3.6' },
      { name: '@asyncapi/go-watermill-template', version: '0.2.76' },
      { name: '@asyncapi/go-watermill-template', version: '0.2.77' },
      { name: '@asyncapi/python-paho-template', version: '0.2.14' },
      { name: '@asyncapi/python-paho-template', version: '0.2.15' },
      { name: '@ensdomains/hardhat-toolbox-viem-extended', version: '0.0.6' },
      { name: '@ensdomains/vite-plugin-i18next-loader', version: '4.0.4' },
      { name: 'zapier-platform-legacy-scripting-runner', version: '4.0.3' },
      { name: 'zapier-platform-legacy-scripting-runner', version: '4.0.4' },
      { name: '@asyncapi/server-api', version: '0.16.25' },
      { name: '@ensdomains/offchain-resolver-contracts', version: '0.2.2' },
      { name: '@zapier/ai-actions', version: '0.1.18' },
      { name: '@zapier/ai-actions', version: '0.1.19' },
      { name: '@zapier/ai-actions', version: '0.1.20' },
      { name: '@zapier/mcp-integration', version: '3.0.1' },
      { name: '@zapier/mcp-integration', version: '3.0.3' },
      { name: '@ensdomains/ens-archived-contracts', version: '0.0.3' },
      { name: '@ensdomains/dnssec-oracle-anchors', version: '0.0.2' },
      { name: '@ensdomains/mock', version: '2.1.52' },
      { name: 'zapier-scripts', version: '7.8.3' },
      { name: 'zapier-scripts', version: '7.8.4' },
      { name: '@quick-start-soft/quick-task-refine', version: '1.4.2511142126' },
      { name: '@zapier/ai-actions-react', version: '0.1.13' },
      { name: '@zapier/ai-actions-react', version: '0.1.14' },
      { name: '@quick-start-soft/quick-git-clean-markdown', version: '1.4.2511142126' },
      { name: '@ensdomains/ui', version: '3.4.6' },
      { name: '@quick-start-soft/quick-markdown', version: '1.4.2511142126' },
      { name: '@zapier/stubtree', version: '0.1.3' },
      { name: '@ensdomains/unruggable-gateways', version: '0.0.3' },
      { name: '@posthog/rrweb-player', version: '0.0.31' },
      { name: '@asyncapi/dotnet-rabbitmq-template', version: '1.0.1' },
      { name: '@asyncapi/dotnet-rabbitmq-template', version: '1.0.2' },
      { name: '@ensdomains/react-ens-address', version: '0.0.32' },
      { name: '@asyncapi/php-template', version: '0.1.1' },
      { name: '@quick-start-soft/quick-document-translator', version: '1.4.2511142126' },
      { name: '@quick-start-soft/quick-markdown-image', version: '1.4.2511142126' },
      { name: '@strapbuild/react-native-date-time-picker', version: '2.0.4' },
      { name: 'github-action-for-generator', version: '2.1.28' },
      { name: '@actbase/react-kakaosdk', version: '0.9.27' },
      { name: 'bytecode-checker-cli', version: '1.0.8' },
      { name: '@markvivanco/app-version-checker', version: '1.0.1' },
      { name: 'bytecode-checker-cli', version: '1.0.9' },
      { name: '@markvivanco/app-version-checker', version: '1.0.2' },
      { name: 'bytecode-checker-cli', version: '1.0.10' },
      { name: '@louisle2/cortex-js', version: '0.1.6' },
      { name: 'orbit-boxicons', version: '2.1.3' },
      { name: 'react-native-worklet-functions', version: '3.3.3' },
      { name: 'poper-react-sdk', version: '0.1.2' },
      { name: '@ensdomains/web3modal', version: '1.10.2' },
      { name: 'gate-evm-tools-test', version: '1.0.5' },
      { name: 'n8n-nodes-tmdb', version: '0.5.1' },
      { name: 'gate-evm-tools-test', version: '1.0.6' },
      { name: 'gate-evm-tools-test', version: '1.0.7' },
      { name: 'capacitor-plugin-purchase', version: '0.1.1' },
      { name: 'expo-audio-session', version: '0.2.1' },
      { name: 'capacitor-plugin-apptrackingios', version: '0.0.21' },
      { name: 'asyncapi-preview', version: '1.0.1' },
      { name: 'asyncapi-preview', version: '1.0.2' },
      { name: '@actbase/react-absolute', version: '0.8.3' },
      { name: '@actbase/react-native-devtools', version: '0.1.3' },
      { name: '@posthog/variance-plugin', version: '0.0.8' },
      { name: '@posthog/twitter-followers-plugin', version: '0.0.8' },
      { name: 'medusa-plugin-momo', version: '0.0.68' },
      { name: 'scgs-capacitor-subscribe', version: '1.0.11' },
      { name: 'gate-evm-check-code2', version: '2.0.3' },
      { name: 'gate-evm-check-code2', version: '2.0.4' },
      { name: 'gate-evm-check-code2', version: '2.0.5' },
      { name: 'lite-serper-mcp-server', version: '0.2.2' },
      { name: '@asyncapi/edavisualiser', version: '1.2.1' },
      { name: '@asyncapi/edavisualiser', version: '1.2.2' },
      { name: 'esbuild-plugin-eta', version: '0.1.1' },
      { name: '@ensdomains/server-analytics', version: '0.0.2' },
      { name: 'zuper-stream', version: '2.0.9' },
      { name: '@quick-start-soft/quick-markdown-compose', version: '1.4.2506300029' },
      { name: '@posthog/snowflake-export-plugin', version: '0.0.8' },
      { name: '@actbase/react-native-kakao-channel', version: '1.0.2' },
      { name: '@posthog/sendgrid-plugin', version: '0.0.8' },
      { name: 'evm-checkcode-cli', version: '1.0.12' },
      { name: '@ensdomains/subdomain-registrar', version: '0.2.4' },
      { name: 'claude-token-updater', version: '1.0.3' },
      { name: 'evm-checkcode-cli', version: '1.0.13' },
      { name: 'evm-checkcode-cli', version: '1.0.14' },
      { name: '@trigo/atrix-pubsub', version: '4.0.3' },
      { name: '@trigo/hapi-auth-signedlink', version: '1.3.1' },
      { name: '@strapbuild/react-native-perspective-image-cropper-poojan31', version: '0.4.6' },
      { name: 'axios-builder', version: '1.2.1' },
      { name: 'calc-loan-interest', version: '1.0.4' },
      { name: 'medusa-plugin-announcement', version: '0.0.3' },
      { name: 'open2internet', version: '0.1.1' },
      { name: '@ensdomains/cypress-metamask', version: '1.2.1' },
      { name: '@ensdomains/renewal', version: '0.0.13' },
      { name: 'cpu-instructions', version: '0.0.14' },
      { name: 'orbit-soap', version: '0.43.13' },
      { name: '@asyncapi/keeper', version: '0.0.2' },
      { name: '@strapbuild/react-native-perspective-image-cropper-2', version: '0.4.7' },
      { name: '@actbase/react-native-actionsheet', version: '1.0.3' },
      { name: '@posthog/ingestion-alert-plugin', version: '0.0.8' },
      { name: '@actbase/react-native-simple-video', version: '1.0.13' },
      { name: '@actbase/react-native-kakao-navi', version: '2.0.4' },
      { name: 'medusa-plugin-zalopay', version: '0.0.40' },
      { name: '@kvytech/medusa-plugin-newsletter', version: '0.0.5' },
      { name: '@posthog/databricks-plugin', version: '0.0.8' },
      { name: '@asyncapi/keeper', version: '0.0.3' },
      { name: 'capacitor-voice-recorder-wav', version: '6.0.3' },
      { name: 'create-hardhat3-app', version: '1.1.1' },
      { name: 'rollup-plugin-httpfile', version: '0.2.1' },
      { name: '@ensdomains/name-wrapper', version: '1.0.1' },
      { name: 'create-hardhat3-app', version: '1.1.2' },
      { name: 'test-foundry-app', version: '1.0.3' },
      { name: 'jan-browser', version: '0.13.1' },
      { name: '@mparpaillon/page', version: '1.0.1' },
      { name: 'go-template', version: '0.1.8' },
      { name: '@strapbuild/react-native-perspective-image-cropper', version: '0.4.15' },
      { name: 'manual-billing-system-miniapp-api', version: '1.3.1' },
      { name: 'korea-administrative-area-geo-json-util', version: '1.0.7' },
      { name: '@posthog/currency-normalization-plugin', version: '0.0.8' },
      { name: '@posthog/web-dev-server', version: '1.0.5' },
      { name: '@posthog/pagerduty-plugin', version: '0.0.8' },
      { name: '@posthog/event-sequence-timer-plugin', version: '0.0.8' },
      { name: '@posthog/automatic-cohorts-plugin', version: '0.0.8' },
      { name: '@posthog/first-time-event-tracker', version: '0.0.8' },
      { name: '@actbase/css-to-react-native-transform', version: '1.0.3' },
      { name: '@posthog/url-normalizer-plugin', version: '0.0.8' },
      { name: '@posthog/twilio-plugin', version: '0.0.8' },
      { name: '@actbase/node-server', version: '1.1.19' },
      { name: '@posthog/gitub-star-sync-plugin', version: '0.0.8' },
      { name: '@seung-ju/react-native-action-sheet', version: '0.2.1' },
      { name: '@posthog/maxmind-plugin', version: '0.1.6' },
      { name: '@posthog/github-release-tracking-plugin', version: '0.0.8' },
      { name: '@actbase/react-native-fast-image', version: '8.5.13' },
      { name: '@posthog/customerio-plugin', version: '0.0.8' },
      { name: '@posthog/kinesis-plugin', version: '0.0.8' },
      { name: '@actbase/react-native-less-transformer', version: '1.0.6' },
      { name: '@posthog/taxonomy-plugin', version: '0.0.8' },
      { name: 'medusa-plugin-product-reviews-kvy', version: '0.0.4' },
      { name: '@aryanhussain/my-angular-lib', version: '0.0.23' },
      { name: 'dotnet-template', version: '0.0.4' },
      { name: 'capacitor-plugin-scgssigninwithgoogle', version: '0.0.5' },
      { name: 'capacitor-purchase-history', version: '0.0.10' },
      { name: '@posthog/plugin-unduplicates', version: '0.0.8' },
      { name: 'posthog-plugin-hello-world', version: '1.0.1' },
      { name: 'esbuild-plugin-httpfile', version: '0.4.1' },
      { name: '@ensdomains/blacklist', version: '1.0.1' },
      { name: '@ensdomains/renewal-widget', version: '0.1.10' },
      { name: '@ensdomains/hackathon-registrar', version: '1.0.5' },
      { name: '@ensdomains/ccip-read-router', version: '0.0.7' },
      { name: '@mcp-use/mcp-use', version: '1.0.1' },
      { name: 'test-hardhat-app', version: '1.0.3' },
      { name: 'zuper-cli', version: '1.0.1' },
      { name: 'skills-use', version: '0.1.2' },
      { name: 'typeorm-orbit', version: '0.2.27' },
      { name: 'orbit-nebula-editor', version: '1.0.2' },
      { name: '@trigo/atrix-elasticsearch', version: '2.0.1' },
      { name: '@trigo/atrix-soap', version: '1.0.2' },
      { name: 'eslint-config-zeallat-base', version: '1.0.4' },
      { name: 'iron-shield-miniapp', version: '0.0.2' },
      { name: 'shinhan-limit-scrap', version: '1.0.3' },
      { name: 'create-glee-app', version: '0.2.3' },
      { name: '@seung-ju/next', version: '0.0.2' },
      { name: '@actbase/react-native-tiktok', version: '1.1.3' },
      { name: 'discord-bot-server', version: '0.1.2' },
      { name: '@seung-ju/openapi-generator', version: '0.0.4' },
      { name: '@seung-ju/react-hooks', version: '0.0.2' },
      { name: '@actbase/react-native-naver-login', version: '1.0.1' },
      { name: '@kvytech/medusa-plugin-announcement', version: '0.0.8' },
      { name: '@kvytech/components', version: '0.0.2' },
      { name: '@kvytech/cli', version: '0.0.7' },
      { name: '@kvytech/medusa-plugin-management', version: '0.0.5' },
      { name: '@kvytech/medusa-plugin-product-reviews', version: '0.0.9' },
      { name: '@kvytech/web', version: '0.0.2' },
      { name: 'scgsffcreator', version: '1.0.5' },
      { name: 'vite-plugin-httpfile', version: '0.2.1' },
      { name: '@ensdomains/curvearithmetics', version: '1.0.1' },
      { name: '@ensdomains/reverse-records', version: '1.0.1' },
      { name: '@ensdomains/ccip-read-dns-gateway', version: '0.1.1' },
      { name: '@ensdomains/unicode-confusables', version: '0.1.1' },
      { name: '@ensdomains/durin-middleware', version: '0.0.2' },
      { name: '@ensdomains/ccip-read-worker-viem', version: '0.0.4' },
      { name: 'atrix', version: '1.0.1' },
      { name: '@caretive/caret-cli', version: '0.0.2' },
      { name: 'exact-ticker', version: '0.3.5' },
      { name: '@orbitgtbelgium/orbit-components', version: '1.2.9' },
      { name: 'react-library-setup', version: '0.0.6' },
      { name: '@orbitgtbelgium/mapbox-gl-draw-scale-rotate-mode', version: '1.1.1' },
      { name: 'orbit-nebula-draw-tools', version: '1.0.10' },
      { name: '@orbitgtbelgium/time-slider', version: '1.0.187' },
      { name: 'react-element-prompt-inspector', version: '0.1.18' },
      { name: '@trigo/pathfinder-ui-css', version: '0.1.1' },
      { name: 'eslint-config-trigo', version: '22.0.2' },
      { name: '@trigo/fsm', version: '3.4.2' },
      { name: '@trigo/atrix', version: '7.0.1' },
      { name: '@trigo/atrix-postgres', version: '1.0.3' },
      { name: 'trigo-react-app', version: '4.1.2' },
      { name: '@trigo/eslint-config-trigo', version: '3.3.1' },
      { name: '@trigo/bool-expressions', version: '4.1.3' },
      { name: '@trigo/trigo-hapijs', version: '5.0.1' },
      { name: '@trigo/node-soap', version: '0.5.4' },
      { name: '@trigo/jsdt', version: '0.2.1' },
      { name: 'bool-expressions', version: '0.1.2' },
      { name: '@trigo/atrix-redis', version: '1.0.2' },
      { name: '@trigo/atrix-acl', version: '4.0.2' },
      { name: '@trigo/atrix-orientdb', version: '1.0.2' },
      { name: '@trigo/atrix-mongoose', version: '1.0.2' },
      { name: 'atrix-mongoose', version: '1.0.1' },
      { name: 'redux-forge', version: '2.5.3' },
      { name: '@trigo/keycloak-api', version: '1.3.1' },
      { name: '@mparpaillon/connector-parse', version: '1.0.1' },
      { name: '@mparpaillon/imagesloaded', version: '4.1.2' },
      { name: '@alaan/s2s-auth', version: '2.0.3' }
    ] AS vulnerable
    UNWIND vulnerable AS v
    MATCH (d:Dependency {ecosystem: 'npm', name: v.name})--(manifest:DependencyGraphManifest)--(r:GitHubRepository)
    RETURN r.fullname as repo, d.name as name, d.requirements as current_version, v.version AS vulnerable_version,
    (REPLACE(d.requirements, "= ", "") = v.version) AS is_vulnerable
    """,
    cypher_visual_query="""
    WITH [
      { name: '@zapier/zapier-sdk', version: '0.15.5' },
      { name: '@zapier/zapier-sdk', version: '0.15.7' },
      { name: '@posthog/core', version: '1.5.6' },
      { name: 'posthog-node', version: '5.11.3' },
      { name: 'posthog-node', version: '5.13.3' },
      { name: 'posthog-node', version: '4.18.1' },
      { name: '@asyncapi/specs', version: '6.10.1' },
      { name: '@asyncapi/specs', version: '6.8.2' },
      { name: '@asyncapi/specs', version: '6.9.1' },
      { name: '@asyncapi/specs', version: '6.8.3' },
      { name: '@postman/tunnel-agent', version: '0.6.6' },
      { name: '@postman/tunnel-agent', version: '0.6.5' },
      { name: 'posthog-react-native', version: '4.12.5' },
      { name: 'posthog-react-native', version: '4.11.1' },
      { name: '@asyncapi/parser', version: '3.4.1' },
      { name: '@asyncapi/parser', version: '3.4.2' },
      { name: '@asyncapi/openapi-schema-parser', version: '3.0.25' },
      { name: '@asyncapi/avro-schema-parser', version: '3.0.25' },
      { name: '@asyncapi/avro-schema-parser', version: '3.0.26' },
      { name: '@asyncapi/protobuf-schema-parser', version: '3.6.1' },
      { name: '@asyncapi/protobuf-schema-parser', version: '3.5.3' },
      { name: '@asyncapi/react-component', version: '2.6.6' },
      { name: '@asyncapi/generator', version: '2.8.5' },
      { name: '@posthog/ai', version: '7.1.2' },
      { name: '@asyncapi/modelina', version: '5.10.2' },
      { name: '@asyncapi/modelina', version: '5.10.3' },
      { name: '@asyncapi/generator-react-sdk', version: '1.1.4' },
      { name: '@asyncapi/generator-react-sdk', version: '1.1.5' },
      { name: '@postman/csv-parse', version: '4.0.3' },
      { name: '@postman/csv-parse', version: '4.0.4' },
      { name: '@postman/csv-parse', version: '4.0.5' },
      { name: 'posthog-react-native-session-replay', version: '1.2.2' },
      { name: '@asyncapi/converter', version: '1.6.3' },
      { name: '@asyncapi/multi-parser', version: '2.2.1' },
      { name: '@asyncapi/multi-parser', version: '2.2.2' },
      { name: '@posthog/cli', version: '0.5.15' },
      { name: '@zapier/secret-scrubber', version: '1.1.3' },
      { name: '@zapier/secret-scrubber', version: '1.1.4' },
      { name: '@zapier/secret-scrubber', version: '1.1.5' },
      { name: 'zapier-platform-schema', version: '18.0.2' },
      { name: 'zapier-platform-core', version: '18.0.2' },
      { name: 'zapier-platform-core', version: '18.0.3' },
      { name: '@ensdomains/address-encoder', version: '1.1.5' },
      { name: '@ensdomains/content-hash', version: '3.0.1' },
      { name: 'crypto-addr-codec', version: '0.1.9' }
    ] AS vulnerable
    UNWIND vulnerable AS v
    MATCH (d:Dependency {ecosystem: 'npm', name: v.name})--(manifest:DependencyGraphManifest)--(r:GitHubRepository)
    RETURN r, d
    """,
    module=Module.GITHUB,
    maturity=Maturity.EXPERIMENTAL,
)


# Rule
class MaliciousNpmDependenciesShaiHuludOutput(Finding):
    repo: str | None = None
    name: str | None = None
    current_version: str | None = None
    vulnerable_version: str | None = None
    is_vulnerable: bool | None = None


malicious_npm_dependencies_shai_hulud = Rule(
    id="malicious-npm-dependencies-shai-hulud",
    name="Repositories with Shai-Hulud Malicious npm Dependencies",
    description="Detects GitHub repositories that depend on npm packages compromised during the Shai-Hulud supply chain attack campaign. This sophisticated attack occurred in multiple waves (September and November 2025), targeting hundreds of npm packages including popular terminal styling libraries (chalk, ansi-regex, strip-ansi), DuckDB-adjacent packages, API integration tools (@zapier/*, @postman/*, @asyncapi/*), analytics packages (@posthog/*), blockchain/ENS packages (@ensdomains/*), and numerous other scoped packages. The presence of these specific malicious versions indicates a supply chain compromise requiring immediate remediation.",
    output_model=MaliciousNpmDependenciesShaiHuludOutput,
    tags=("supply_chain", "cti", "shai_hulud"),
    facts=(_malicious_npm_dependencies_shai_hulud_sept_2025_github, _malicious_npm_dependencies_shai_hulud_nov_2025_github),
    version="0.1.0",
    references=[
        RuleReference(
            text="YCombinator - Shai-Hulud: 300+ NPM Packages Infected",
            url="https://news.ycombinator.com/item?id=46032539",
        ),
        RuleReference(
            text="HelixGuard - Malicious SHA1Hulud Campaign Hits NPM",
            url="https://helixguard.ai/blog/malicious-sha1hulud-2025-11-24",
        ),
        RuleReference(
            text="YCombinator - npm debug & chalk Packages Compromised",
            url="https://news.ycombinator.com/item?id=45169657",
        ),
        RuleReference(
            text="Aikido.dev - npm debug + chalk Attack Deep Dive",
            url="https://www.aikido.dev/blog/npm-debug-and-chalk-packages-compromised",
        ),
        RuleReference(
            text="GitHub - Issue #656: Chalk Package Attack on NPM",
            url="https://github.com/chalk/chalk/issues/656",
        ),
        RuleReference(
            text="GitHub - Issue #1005: Debug Package Publishing Breach",
            url="https://github.com/debug-js/debug/issues/1005#issuecomment-3266885191",
        ),
    ],
)
